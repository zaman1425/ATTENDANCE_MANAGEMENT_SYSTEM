version: "3.9"

services:
  db:
    image: postgres:15
    container_name: hal_postgres
    restart: always
    env_file:
      - .env
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"

  web:
    build: .
    container_name: hal_flask_app
    restart: always
    depends_on:
      - db
    env_file:
      - .env
    ports:
      - "8000:5000"
    command: gunicorn -b 0.0.0.0:5000 app:app

  db_backup:
    image: postgres:15
    container_name: hal_db_backup
    restart: always
    depends_on:
      - db
    env_file:
      - .env
    volumes:
      - ./db_backups:/backups
    entrypoint: >
      sh -c "
      while true; do
        echo 'ðŸ“¦ Taking DB backup...';
        pg_dump -h db -U $$POSTGRES_USER $$POSTGRES_DB \
        > /backups/backup_$(date +%F_%H-%M-%S).sql;
        echo 'âœ… Backup completed';
        sleep 86400;
      done
      "

volumes:
  postgres_data:
